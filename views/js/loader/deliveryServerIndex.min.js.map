{"version":3,"names":["loaderScript","document","getElementById","configUrl","getAttribute","bundle","loadController","controllerOptions","controllerPath","params","JSON","parse","err","window","require","controller","startController","started","start","addEventListener","readyState","loadBundles","loaded","bundles","concat","filter","item","index","indexOf","forEach","length","define","$","_","__","module","router","feedback","loggerFactory","loadingBar","context","locale","logger","accessibilityLaunchKeyCodes","displayPermanentMessage","level","content","timeout","popup","getLTIErrorParameters","searchParams","URL","location","href","reduce","paramName","has","get","parameters","deliveryStarted","runDelivery","url","isString","isEmpty","supportRTL","attr","dir","getLanguageDirection","config","messages","message","lti_errormsg","ltiErrorMsg","lti_errorlog","ltiErrorLog","error","launchDelivery","e","$elt","currentTarget","preventDefault","stopPropagation","hasClass","data","launch_url","on","includes","which","isArray","extraRoutes","dispatch"],"sources":["../../loader/bootstrap.js","../controller/DeliveryServer/index.js","module-create.js"],"sourcesContent":["/**\n * This program is free software; you can redistribute it and/or\n * modify it under the terms of the GNU General Public License\n * as published by the Free Software Foundation; under version 2\n * of the License (non-upgradable).\n *\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with this program; if not, write to the Free Software\n * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.\n *\n * Copyright (c) 2016-2018 (original work) Open Assessment Technologies SA ;\n */\n\n/**\n * Bootstrap the app, start the entry controller\n * @author Bertrand Chevrier <bertrand@taotesting.com>\n */\n(function(){\n    'use strict';\n\n\n\n    var loaderScript = document.getElementById('amd-loader');\n    var configUrl = loaderScript.getAttribute('data-config');\n    var bundle  = loaderScript.getAttribute('data-bundle');\n\n    var loadController = function loadController(){\n        var controllerOptions = {};\n        var controllerPath = loaderScript.getAttribute('data-controller');\n        var params = loaderScript.getAttribute('data-params');\n        try{\n            controllerOptions = JSON.parse(params);\n        } catch(err){\n            controllerOptions = {};\n        }\n        window.require([controllerPath], function(controller) {\n            var startController = function startController(){\n                if(!window.started){\n                    window.started = true;\n                    controller.start(controllerOptions);\n                }\n            };\n            document.addEventListener('readystatechange', startController, false);\n            if (document.readyState === 'complete') {\n                startController();\n            }\n        });\n    };\n\n    //always start to load the config\n    window.require([configUrl], function() {\n\n        //define the global loading mechanism\n        if(!window.loadBundles){\n            //keep tracl of loaded bundles, even if require does it,\n            //this prevent some unecessary cycles\n            window.loaded = {};\n\n            /**\n             * Loading entry point for inter bundle dependency,\n             * always take the bundles from the params and window.bundles\n             * @param {String[]} [bundles] - an optional list of bundle to load\n             */\n            window.loadBundles = function loadBundles(bundles){\n                bundles = bundles || [];\n                bundles = bundles.concat(window.bundles)\n                bundles = bundles.filter( function(item, index){\n                    return item && bundles.indexOf(item) === index && window.loaded[item] !== true;\n                });\n                require(bundles, function(){\n                    bundles.forEach( function( item ) {\n                        window.loaded[item] = true;\n                    });\n                    loadController();\n                });\n            }\n        }\n\n        if(bundle || (window.bundles && window.bundles.length)) {\n            window.loadBundles([bundle]);\n        } else {\n            loadController();\n        }\n    });\n})();\n\ndefine(\"loader/bootstrap\", function(){});\n\n","/*\n * This program is free software; you can redistribute it and/or\n * modify it under the terms of the GNU General Public License\n * as published by the Free Software Foundation; under version 2\n * of the License (non-upgradable).\n *\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with this program; if not, write to the Free Software\n * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.\n *\n * Copyright (c) 2016-2019 (original work) Open Assessment Technologies SA ;\n *\n */\n\n/**\n * The DeliveryServer/index controller.\n *\n * @author Bertrand Chevrier <bertrand@taotesting.com>\n */\ndefine('taoDelivery/controller/DeliveryServer/index',[\n    'jquery',\n    'lodash',\n    'i18n',\n    'module',\n    'core/router',\n    'ui/feedback',\n    'core/logger',\n    'layout/loading-bar',\n    'context',\n    'util/locale',\n    'url-polyfill'\n], function($, _, __, module, router, feedback, loggerFactory, loadingBar, context, locale){\n    'use strict';\n\n    const logger = loggerFactory('deliveryServer');\n\n    const accessibilityLaunchKeyCodes = [13, 32];  // \"enter\" or \"space\" - list of keys able to run delivery\n\n    /**\n     * Display a permanent message\n     * @param {String} level - in supported feedbacks' levels\n     * @param {String} content - the message to display\n     */\n    const displayPermanentMessage = (level, content) => {\n        if(level && content){\n            feedback($('.permanent-feedback'))[level](content, {\n                timeout : -1,\n                popup : false\n            });\n        }\n    };\n\n    /**\n     * Extract standard LTI error parameters from query string\n     * @returns {Object} LTI error parameters\n     */\n    const getLTIErrorParameters = () => {\n        const { searchParams } = new URL(window.location.href);\n\n        return ['lti_errormsg', 'lti_errorlog'].reduce((params, paramName) => {\n            if (searchParams.has(paramName)) {\n                params[paramName] = searchParams.get(paramName);\n            }\n            return params;\n        }, {});\n    };\n\n    /**\n     * The DeliveryServer/index controller\n     */\n    return {\n\n        /**\n         * Controller entry point\n         * @param {Object} [parameters] - controller's data\n         * @param {Object} [parameters.messages] - message data to display\n         */\n        start(parameters){\n            let deliveryStarted = false;\n\n            /**\n             * Run/open the given delivery\n             * @param {String} url - the delivery URL\n             */\n            const runDelivery = function runDelivery (url) {\n                if(_.isString(url) && !_.isEmpty(url)){\n                    deliveryStarted = true;\n                    loadingBar.start();\n                    window.location.href = url;\n                }\n            };\n\n            /**\n             * improve UI to support rtl languages\n             */\n            const supportRTL = function supportRTL () {\n                // adding attr for RTL languages\n                $('.delivery-scope').attr({dir: locale.getLanguageDirection(context.locale)});\n            };\n\n            const config = module.config();\n\n            // display as feedbacks any messages in parameters\n            if (parameters && parameters.messages) {\n                _.forEach(parameters.messages, message => {\n                    displayPermanentMessage(message.level, message.content);\n                });\n            }\n\n            // display as feedbacks any LTI error messages from query string\n            const { lti_errormsg: ltiErrorMsg, lti_errorlog: ltiErrorLog } = getLTIErrorParameters();\n\n            if (ltiErrorMsg) {\n                displayPermanentMessage('error', ltiErrorMsg.length ? ltiErrorMsg : __('An error occurred!'));\n            };\n            if (ltiErrorLog) {\n                logger.error(ltiErrorLog);\n            };\n\n            const launchDelivery = function (e) {\n                const $elt = $(e.currentTarget);\n\n                e.preventDefault();\n                e.stopPropagation();\n\n                if(!deliveryStarted && !$elt.hasClass('disabled')){\n                    runDelivery($elt.data().launch_url);\n                }\n            };\n\n            supportRTL();\n            $('.entry-point').on('click', launchDelivery);\n            $('.entry-point').on('keyup', (e) => {\n                if(accessibilityLaunchKeyCodes.includes(e.which)) {\n                    launchDelivery(e);\n                }\n            });\n\n            // dispatch any extra registered routes\n            if (config && _.isArray(config.extraRoutes) && config.extraRoutes.length) {\n                router.dispatch(config.extraRoutes);\n            }\n        }\n    };\n});\n\n","\ndefine(\"taoDelivery/loader/deliveryServerIndex.bundle\", function(){});\n"],"mappings":"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"}